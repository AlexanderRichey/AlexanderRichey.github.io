<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Alex Richey &middot; Web Developer
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/my-poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/my-hyde.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73275866-1', 'auto');
  ga('send', 'pageview');

</script>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Alex Richey
        </a>
      </h1>
      <p class="lead">I'm a web developer and occasional columnist based in NYC. I write about politics and code.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item active" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="/dev/">Portfolio</a>

    </nav>

    <p class="lead">&copy; 2017. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/08/07/setting-up-ssr-react-django/">
        Setting Up Server Side Rendering with React, React-Router 3, Redux, and Django
      </a>
    </h1>

    <span class="post-date">07 Aug 2017</span>

    <p>At a high level, setting up server side rendering consists in setting up the following chain of events.</p>

<ol>
  <li>Server receives request.</li>
  <li>Database is queried and needed information is received in memory.</li>
  <li>Needed information plus a desired path are passed into a render function.</li>
  <li>The render function returns markup that is then sent down to the client.</li>
</ol>

<p>Since neither Python nor Django can understand JavaScript, we need a Node runtime to render our React app. Therefore, we need a dedicated render server. When a request hits our server, we’ll query our database to get the info we need. Then we’ll send that info in an http <code class="highlighter-rouge">POST</code> request to our render server, which will return our markup, plus the final state of our Redux store.</p>

<p>Let’s start out by getting that much setup. In order to write this code in a testable way, we’ll start with a first pass at the render server.</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="c1">// server.js</span>

<span class="kr">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">morgan</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'morgan'</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">ADDRESS</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_HOST</span>
<span class="kr">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_PORT</span>

<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>

<span class="c1">// I've increased the limit of the max payload size in case a huge page</span>
<span class="c1">// needs to be rendered</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">limit</span><span class="p">:</span> <span class="s1">'10mb'</span> <span class="p">}))</span>

<span class="c1">// Morgan is the very silly name of some logging middleware</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="s1">'combined'</span><span class="p">))</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'Render server here!'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/render'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// We know we'll need a path and the data for our initial state,</span>
  <span class="c1">// so let's save this stuff first</span>
  <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">url</span>
  <span class="kr">const</span> <span class="nx">initialState</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">initialState</span>

  <span class="c1">// Eventually we'll return markup and our final state. For now,</span>
  <span class="c1">// for the sake of testing, let's just return our inputs</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
    <span class="na">html</span><span class="p">:</span> <span class="nx">url</span><span class="p">,</span>
    <span class="na">finalState</span><span class="p">:</span> <span class="nx">initialState</span>
  <span class="p">})</span>
<span class="p">})</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="nx">ADDRESS</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Render server listening at http://'</span> <span class="o">+</span> <span class="nx">ADDRESS</span> <span class="o">+</span> <span class="s1">':'</span> <span class="o">+</span> <span class="nx">PORT</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
</div>

<p>Let’s test this in the shell with cURL before wiring up the Django app.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># Fire up the server</span>
<span class="gp">$ </span>node server.js
Render server listening at http://localhost:9009

<span class="c"># In another window, let's test it</span>
<span class="gp">$ </span>curl http://localhost:9009
Render server here!

<span class="gp">$ </span>curl -X POST -d <span class="s1">'{"url": "/", "initialState", {}}'</span> http://localhost:9009
<span class="o">{</span>
  html: <span class="s2">"/"</span>,
  finalState: <span class="o">{}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Looks good so far. Now let’s wire up the Django app and test it’s interaction with the render server.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># views.py</span>

<span class="k">def</span> <span class="nf">sandwich</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sandwich</span> <span class="o">=</span> <span class="n">Sandwich</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">sandwich_data</span> <span class="o">=</span> <span class="n">sandwich</span><span class="o">.</span><span class="n">to_user</span><span class="p">()</span>
        <span class="c"># Sandwich#to_user is a method that returns a nice sandwich object</span>
    <span class="k">except</span> <span class="n">Sandwich</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">sandwich_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c"># The magic happens in our _react_render helper function</span>
    <span class="k">return</span> <span class="n">_react_render</span><span class="p">({</span><span class="s">'sandwich'</span><span class="p">:</span> <span class="n">sandwich_data</span><span class="p">},</span> <span class="n">request</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_react_render</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="c"># Let's grab our user's info if she has any</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="c"># User#to_client is another little helper method that returns</span>
        <span class="c"># an object just the way we want it</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">to_client</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># Here's what we've got so far</span>
    <span class="n">render_assets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'url'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">path_info</span><span class="p">,</span>
        <span class="s">'user'</span><span class="p">:</span> <span class="n">user</span>
    <span class="p">}</span>
    <span class="c"># Now we add the sandwich. We use the Dict#update method so that the</span>
    <span class="c"># key could be anything, like pizza or cake or burger.</span>
    <span class="n">render_assets</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># All right, let's send it! Here we use requests, a very nice wrapper</span>
        <span class="c"># around urllib. Note that we set the content type to json.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">RENDER_SERVER_BASE_URL</span> <span class="o">+</span> <span class="s">'/render'</span><span class="p">,</span>
                            <span class="n">json</span><span class="o">=</span><span class="n">render_assets</span><span class="p">,</span>
                            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'content_type'</span><span class="p">:</span> <span class="s">'application/json'</span><span class="p">})</span>
        <span class="n">rendered_payload</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c"># If we get here, then something broke! Let's report that error</span>
        <span class="c"># and return some default data.</span>
        <span class="n">ErrorReporter</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">ErrorReporter</span><span class="o">.</span><span class="n">RENDER_SERVER_FAILURE</span><span class="p">,</span> <span class="p">{</span><span class="s">'error'</span><span class="p">:</span> <span class="n">e</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'base.html'</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">'html'</span><span class="p">:</span> <span class="s">''</span><span class="p">,</span>
            <span class="s">'finalState'</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({}),</span>
        <span class="p">})</span>
    <span class="c"># Beautiful! Let's render this stuff into our base template</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'base.html'</span><span class="p">,</span> <span class="n">rendered_payload</span><span class="p">)</span>
</code></pre>
</div>

<p>Here’s how we insert our rendered react app into our more standard Django template. If you want to support meta tags, etc., all you need to do is add that data to the <code class="highlighter-rouge">rendered_payload</code> object and then reference it in the template.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="c">&lt;!-- base.html --&gt;</span>
{ load render_bundle from webpack_loader }
{ load webpack_static from webpack_loader }

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"x-ua-compatible"</span> <span class="na">content=</span><span class="s">"ie=edge"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>The Finest Deli<span class="nt">&lt;/title&gt;</span>

    { render_bundle 'bodega' 'css' }
    { render_bundle 'bodega' 'js' attrs='async' }
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>

    <span class="c">&lt;!-- Root --&gt;</span>
    <span class="nt">&lt;main</span> <span class="na">id=</span><span class="s">"root"</span><span class="nt">&gt;</span>{ html|safe }<span class="nt">&lt;/main&gt;</span>

    <span class="c">&lt;!-- Redux State --&gt;</span>
    <span class="nt">&lt;script&gt;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">__REDUX_STATE__</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">finalState</span><span class="o">|</span><span class="nx">safe</span> <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>

  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p>We’re ready to test again. Let’s fire up our Django server, open up a browser, and go to the url that corresponds to our sandwich view. To prevent our React frontend from taking over the page on load, let’s disable JavaScript in DevTools. If you see a page with a slash on it, you’re in business!</p>

<p>Now let’s go back to our <code class="highlighter-rouge">server.js</code> and think about how we want to handle rendering. We’ll want to call a render method, which we haven’t written yet, and we’ll also need to massage our initialState data so that it matches the shape of our Redux store.</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="c1">// server.js</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/render'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">url</span>
  <span class="kr">const</span> <span class="nx">initialState</span> <span class="o">=</span> <span class="nx">buildInitialState</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="c1">// Massages data into the</span>
                                                   <span class="c1">// shape of our Redux store</span>

  <span class="c1">// Haven't written this yet, but this is what it'll output</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">render</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">initialState</span><span class="p">)</span>

  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
    <span class="na">html</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">html</span><span class="p">,</span>
    <span class="na">finalState</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">finalState</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre>
</div>

<p>Now we’re getting to the interesting part: the actual render function. This function will have to import our entire React frontend, which means that we’ll have to run it through webpack to handle all of our dependences and to transpile our source into ES5 since not all ES6 features are supported yet. We also have to change our webpack target runtime to <code class="highlighter-rouge">node</code>, since we won’t be running in the browser.</p>

<p>The fact that our React app won’t be running in the browser also means that <code class="highlighter-rouge">window</code> and <code class="highlighter-rouge">document</code> will not be defined. Therefore, <strong><em>all references to the <code class="highlighter-rouge">window</code> and <code class="highlighter-rouge">document</code> must not occur in code that gets executed prior to mounting to the DOM</em></strong>. Such references need to be moved to component lifecycle methods like <code class="highlighter-rouge">Component#componentDidMount</code> that are fired after mounting. This may involve a bit of work and you may also need to alter some of your dependences if they refer to <code class="highlighter-rouge">window</code> in problematic places.</p>

<p>Assuming your React app is in good shape, let’s now write another webpack config to bundle our app for the server before writing our render function.</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="c1">// webpack.server.config.js</span>

<span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">webpack</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpack'</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'server-side rendering'</span><span class="p">,</span>
  <span class="na">entry</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'render_server'</span><span class="p">,</span> <span class="s1">'render.jsx'</span><span class="p">),</span>
  <span class="na">target</span><span class="p">:</span> <span class="s1">'node'</span><span class="p">,</span> <span class="c1">// Here's the only interesting part</span>
  <span class="na">output</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">path</span><span class="p">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'render_server'</span><span class="p">,</span> <span class="s1">'dist'</span><span class="p">),</span>
    <span class="na">filename</span><span class="p">:</span> <span class="s1">'bodega.server.js'</span><span class="p">,</span>
    <span class="na">publicPath</span><span class="p">:</span> <span class="s1">'/static/'</span><span class="p">,</span>
    <span class="na">libraryTarget</span><span class="p">:</span> <span class="s1">'commonjs2'</span>
  <span class="p">},</span>
  <span class="na">externals</span><span class="p">:</span> <span class="sr">/^</span><span class="se">[</span><span class="sr">a-z</span><span class="se">\-</span><span class="sr">0-9</span><span class="se">]</span><span class="sr">+$/</span><span class="p">,</span>
  <span class="na">module</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">rules</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">test</span><span class="p">:</span> <span class="sr">/</span><span class="se">\.</span><span class="sr">jsx</span><span class="se">?</span><span class="sr">$/</span><span class="p">,</span>
        <span class="na">exclude</span><span class="p">:</span> <span class="sr">/node_modules/</span><span class="p">,</span>
        <span class="na">loader</span><span class="p">:</span> <span class="s1">'babel-loader'</span><span class="p">,</span>
        <span class="na">query</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">presets</span><span class="p">:</span> <span class="p">[</span><span class="s1">'react'</span><span class="p">,</span> <span class="s1">'es2015'</span><span class="p">,</span> <span class="s1">'stage-0'</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="na">test</span><span class="p">:</span> <span class="sr">/</span><span class="se">\.(</span><span class="sr">ttf|otf|eot|svg|woff</span><span class="se">(</span><span class="sr">2</span><span class="se">)?)(\?[</span><span class="sr">a-z0-9</span><span class="se">]</span><span class="sr">+</span><span class="se">)?</span><span class="sr">$|</span><span class="se">\.</span><span class="sr">jpe</span><span class="se">?</span><span class="sr">g$|</span><span class="se">\.</span><span class="sr">gif$|</span><span class="se">\.</span><span class="sr">png$|</span><span class="se">\.</span><span class="sr">svg$/</span><span class="p">,</span>
        <span class="na">loader</span><span class="p">:</span> <span class="s1">'file-loader?name=[name].[ext]'</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="na">plugins</span><span class="p">:</span> <span class="p">[</span>
    <span class="k">new</span> <span class="nx">webpack</span><span class="p">.</span><span class="nx">DefinePlugin</span><span class="p">({</span>
      <span class="s1">'process.env'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'NODE_ENV'</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="s1">'production'</span><span class="p">),</span>
        <span class="c1">// Added `server` env variable in case you need to make adjustments to</span>
        <span class="c1">// your code based on where it's going to be run</span>
        <span class="s1">'MACHINE'</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="s1">'server'</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">],</span>
  <span class="na">resolve</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">extensions</span><span class="p">:</span> <span class="p">[</span><span class="s1">'.js'</span><span class="p">,</span> <span class="s1">'.jsx'</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now let’s actually write our render function. There’s a number of things we need to consider.</p>

<ul>
  <li>Which resource to use to render our app to markup</li>
  <li>How to import our existing React app</li>
  <li>How to match the desired route with React Router 3</li>
  <li>How to handle the React-Redux <code class="highlighter-rouge">&lt;Provider&gt;</code> component</li>
</ul>

<p>Let’s take these questions in order. To render our app to markup, we can use the <code class="highlighter-rouge">ReactDOMServer#renderToString</code> method. This takes a React component and renders it to a giant string of html markup. Easy.</p>

<p>In importing our existing React app, we can’t use our standard entry point, since that references the <code class="highlighter-rouge">document</code>, waits for <code class="highlighter-rouge">DOMContentLoaded</code>, etc. We also can’t use the version of React-Router that we use in browser, since that requires <code class="highlighter-rouge">browserHistory</code>, which isn’t available in Node runtime.</p>

<p>To resolve these difficulties, I abstracted my app’s routes into a new function called <code class="highlighter-rouge">getRoutes</code>. It takes the Redux store as an argument and returns all of the routes to my app, with all of their embedded components. I then use this function to insert my routes into a <code class="highlighter-rouge">&lt;Router&gt;</code> component in my browser entry point and to insert my routes into React-Router’s <code class="highlighter-rouge">match</code> function in my server entry point.</p>

<p>The <code class="highlighter-rouge">match</code> function is how we match the desired route on the server side. It’s first argument is an object containing all of our app’s routes as its first key, and our desired location as the second key. The <code class="highlighter-rouge">match</code> function’s second argument is a callback that gets evoked after matching is complete. In a successful matching, the callback’s third argument will be a <code class="highlighter-rouge">renderProps</code> object. The <code class="highlighter-rouge">renderProps</code> represent the state of our app’s props at a given location. We can then use React-Router’s <code class="highlighter-rouge">&lt;RouterContext&gt;</code> component, which is sort of like a static version of its more familiar <code class="highlighter-rouge">&lt;Router&gt;</code> component, to render the state of our app with the given <code class="highlighter-rouge">renderProps</code>.</p>

<p>Finally, we can wrap our <code class="highlighter-rouge">&lt;RouterContext&gt;</code> with React-Redux’s <code class="highlighter-rouge">&lt;Provider&gt;</code> so that all of the components in the tree can access the Redux store.</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="c1">// render.jsx</span>

<span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Provider</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-redux'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">RouterContext</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-router'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Helmet</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-helmet'</span>
<span class="kr">import</span> <span class="nx">ReactDOMServer</span> <span class="nx">from</span> <span class="s1">'react-dom/server'</span>
<span class="kr">import</span> <span class="nx">configureStore</span> <span class="nx">from</span> <span class="s1">'../bodega/src/scripts/store/store'</span>
<span class="kr">import</span> <span class="nx">getRoutes</span> <span class="nx">from</span> <span class="s1">'../bodega/src/scripts/components/routes'</span>

<span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">render</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">initialState</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">configureStore</span><span class="p">(</span><span class="nx">initialState</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">getRoutes</span><span class="p">(</span><span class="nx">store</span><span class="p">)</span>

  <span class="kd">let</span> <span class="nx">html</span><span class="p">,</span> <span class="nx">redirect</span>
  <span class="nx">match</span><span class="p">({</span> <span class="nx">routes</span><span class="p">,</span> <span class="na">location</span><span class="p">:</span> <span class="nx">url</span> <span class="p">},</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">redirectLocation</span><span class="p">,</span> <span class="nx">renderProps</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">redirectLocation</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">redirect</span> <span class="o">=</span> <span class="nx">redirectLocation</span><span class="p">.</span><span class="nx">pathname</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">renderProps</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Here's where the actual rendering happens</span>
      <span class="nx">html</span> <span class="o">=</span> <span class="nx">ReactDOMServer</span><span class="p">.</span><span class="nx">renderToString</span><span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">Provider</span> <span class="nx">store</span><span class="o">=</span><span class="p">{</span><span class="nx">store</span><span class="p">}</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="nx">RouterContext</span> <span class="p">{...</span><span class="nx">renderProps</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="sr">/Provider</span><span class="err">&gt;
</span>      <span class="p">)</span>
      <span class="nx">Helmet</span><span class="p">.</span><span class="nx">renderStatic</span><span class="p">()</span> <span class="c1">// This is called to prevent a memory leak.</span>
                            <span class="c1">// See https://github.com/nfl/react-helmet#server-usage</span>
                            <span class="c1">// for more info.</span>
    <span class="p">}</span>
  <span class="p">})</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">redirect</span><span class="p">)</span> <span class="k">return</span> <span class="nx">render</span><span class="p">(</span><span class="nx">redirect</span><span class="p">,</span> <span class="nx">initialState</span><span class="p">)</span> <span class="c1">// Recursion, baby</span>

  <span class="kr">const</span> <span class="nx">finalState</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">()</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">html</span><span class="p">,</span>
    <span class="nx">finalState</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Beautiful! Let’s tell webpack to build our server bundle, import it into <code class="highlighter-rouge">server.js</code> to define the render function, and test our work by opening up the Sandwich page in a browser with JavaScript disabled. If everything is setup properly, we should see our fully rendered React app in the initial server response.</p>

<p>There is now just one more detail to work out, that is, how to configure our browser entry point to start Redux with the pre-rendered store. This is pretty easy, since all we have to do is pass <code class="highlighter-rouge">window.__REDUX_STATE__</code> into our <code class="highlighter-rouge">configureStore</code> method.</p>

<p>Finally, you also might have noticed that I added an <code class="highlighter-rouge">async</code> attribute to my script tag in <code class="highlighter-rouge">base.html</code>. The <code class="highlighter-rouge">async</code> attribute makes the tag non-render-blocking, which means that the browser won’t wait for the entire script to download before rendering. This produces a considerable speed increase, especially with large JavaScript bundles. However, it also means that it is possible for the script to be loaded at any time during the load process, which means that the standard procedure of waiting for <code class="highlighter-rouge">DOMContentLoaded</code> before rendering with <code class="highlighter-rouge">ReactDOM</code> might not always work, since <code class="highlighter-rouge">DOMContentLoaded</code> might have already fired, in which case, the React app would never get executed and the page would never become interactive. Therefore, I check the <code class="highlighter-rouge">document.readyState</code> when the bundle is initially loaded. If the <code class="highlighter-rouge">readyState</code> is <code class="highlighter-rouge">complete</code> or <code class="highlighter-rouge">interactive</code>, I initialize my React app right away. Otherwise, I add listener for <code class="highlighter-rouge">DOMContentLoaded</code> and use my initialize function as the callback.</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span>
<span class="kr">import</span> <span class="nx">ReactDOM</span> <span class="nx">from</span> <span class="s1">'react-dom'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">match</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-router'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Provider</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-redux'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Router</span><span class="p">,</span> <span class="nx">browserHistory</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-router'</span>

<span class="kr">import</span> <span class="nx">configureStore</span> <span class="nx">from</span> <span class="s1">'./bodega/store/store'</span>
<span class="kr">import</span> <span class="nx">Root</span> <span class="nx">from</span> <span class="s1">'./bodega/components/root'</span>
<span class="kr">import</span> <span class="nx">getRoutes</span> <span class="nx">from</span> <span class="s1">'./bodega/components/routes'</span>

<span class="kr">import</span> <span class="s1">'./styles/main.scss'</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">'loading'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'DOMContentLoaded'</span><span class="p">,</span> <span class="nx">initializeApp</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">initializeApp</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">initializeApp</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">configureStore</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">__REDUX_STATE__</span><span class="p">)</span>

  <span class="kr">const</span> <span class="p">{</span> <span class="nx">pathname</span><span class="p">,</span> <span class="nx">search</span><span class="p">,</span> <span class="nx">hash</span> <span class="p">}</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span>
  <span class="kr">const</span> <span class="nx">location</span> <span class="o">=</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">pathname</span><span class="p">}</span><span class="nx">$</span><span class="p">{</span><span class="nx">search</span><span class="p">}</span><span class="nx">$</span><span class="p">{</span><span class="nx">hash</span><span class="p">}</span><span class="err">`</span>
  <span class="kr">const</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">getRoutes</span><span class="p">(</span><span class="nx">store</span><span class="p">)</span>

  <span class="nx">match</span><span class="p">({</span> <span class="nx">routes</span><span class="p">,</span> <span class="nx">location</span> <span class="p">},</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">Provider</span> <span class="nx">store</span><span class="o">=</span><span class="p">{</span><span class="nx">store</span><span class="p">}</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">Router</span> <span class="nx">history</span><span class="o">=</span><span class="p">{</span><span class="nx">browserHistory</span><span class="p">}</span><span class="o">&gt;</span>
          <span class="p">{</span><span class="nx">getRoutes</span><span class="p">(</span><span class="nx">store</span><span class="p">)}</span>
        <span class="o">&lt;</span><span class="sr">/Router</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/Provider</span><span class="err">&gt;
</span>      <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now let’s enable JavaScript in our browser again, hit reload, and marvel at the speed of server side rendering.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/05/21/from-philosophy-to-cs/">
        From Philosophy to Computer Science
      </a>
    </h1>

    <span class="post-date">21 May 2016</span>

    <p><img src="/assets/philosophy.jpg" alt="image" />
When I say that I’m a software developer with a background in academic philosophy, many people react with surprise, as if I had jumped between completely divergent fields. Philosophy and computer science are in fact closely related and it is easy to transition from one to the other. In this article I would like to highlight a few reasons why this is so, with the hopes of dispelling the common misperception that they are opposites and of giving some background for students of philosophy who are interested in transitioning to computer science.</p>

<h2 id="logical-similarities">Logical Similarities</h2>

<p>The basis of both philosophy and computer science is logic. In philosophy, it’s often used to evaluate arguments, whereas in computer science, it is the means by which the processor is given instructions. Having a good grasp of logic’s core concepts is essential to do well in either.</p>

<p>Consider this example to see what I mean. Suppose I say,</p>

<blockquote>
  <p>If Trump or Hillary wins, then all is lost.</p>
</blockquote>

<p>This statement can be represented in philosophical notation as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(1) (A ∨ B) → C
</code></pre>
</div>

<p>where <code class="highlighter-rouge">A</code> is “Trump wins”, <code class="highlighter-rouge">B</code> is “Hillary wins”, <code class="highlighter-rouge">C</code> is “All is lost,” and  <code class="highlighter-rouge">∨</code> and <code class="highlighter-rouge">→</code> are shorthand for “or” and “If … then …,” respectively.</p>

<p>Now let’s write a simple program that captures the content of our claim. Let’s make our computer print “All is lost,” if either Hillary or Trump win, and print “Not all is lost,” if neither of them wins.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="n">trump_wins</span> <span class="o">||</span> <span class="n">hillary_wins</span>
    <span class="nb">print</span> <span class="s2">"All is lost."</span>
<span class="k">else</span>
    <span class="nb">print</span> <span class="s2">"Not all is lost."</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Cool. If we run this program after the election, it will print “All is lost,” or “Not all is lost,” depending on the result. Notice that, as far as the logic is concerned, we’ve used the exact same concepts that we used in expressing (1). The only difference is <em>syntax</em>. Here, the <code class="highlighter-rouge">→</code> is represented as a multi-line command and  <code class="highlighter-rouge">∨</code> is represented as <code class="highlighter-rouge">||</code>. The other addition that we’ve made is to add an imperative, namely, <code class="highlighter-rouge">print</code>. This is one of the main differences between pure logic and programming: Computers do things in the physical world; pure logic does not.</p>

<p>The advantage of a background in philosophy is that you are already able to translate colloquial statements into logical formulae, just as programmers do. As a student of philosophy, moreover, this kind of knowledge allows you to craft and criticize arguments. As a computer programmer, the same knowledge enables you to see several ways of building the same program; and the ability to see the far reaching, logical entailments of your claims often makes it easier to spot bugs.</p>

<h2 id="analytical-similarities">Analytical Similarities</h2>

<p>The way that one evaluates a philosophical position is surprisingly similar to the way a computer processor evaluates code. Both involve analytically determining what follows from what.</p>

<p>Consider the position of utilitarianism. According to this view,</p>

<blockquote>
  <p>What is good is what maximizes happiness. The virtuous choice is the one that maximizes happiness.</p>
</blockquote>

<p>In order to evaluate this position, we need to consider its implications and ask if they are sound. If there is an unsound consequence, then the following logic will undermine the position. Schematically, where <code class="highlighter-rouge">¬</code> is ‘not,’ <code class="highlighter-rouge">A</code> is “What is good is what maximizes happiness,” and <code class="highlighter-rouge">B</code> is some unsound consequence, we have:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Assume:            A → B
Assume:            A
By Modus Ponens:   B
Assume:           ¬B
By Modus Tollens: ¬A ∎
</code></pre>
</div>

<p>This argument shows that, if there is some unsound consequence <code class="highlighter-rouge">B</code>, then <code class="highlighter-rouge">A</code> cannot be true.</p>

<p>In computer programming, the style of thinking involved is remarkably similar. Suppose you are writing a computer program that plays chess and you need to write a function that checks the board to see if there is a checkmate. You might start out with something like this:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">checkmate?</span>
  <span class="k">if</span> <span class="n">current_player</span><span class="p">.</span><span class="nf">king</span><span class="p">.</span><span class="nf">is_capturable?</span>
    <span class="k">return</span> <span class="kp">true</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This function checks to see if the current player’s king can be captured. If it is, it returns <code class="highlighter-rouge">true</code>; otherwise, it returns <code class="highlighter-rouge">false</code>.</p>

<p>In order to evaluate this code, we perform a <em>mental stack trace</em>, that is, we imagine, as best we can, how the computer will process the code that we have just written. If our code is successful, all checkmated boards will be identified; otherwise, they won’t be. Similarly, in the philosophical case, we evaluate our position by imagining all possible entailments. If our position is successful, we’ll agree with all of the entailments; otherwise, we won’t.</p>

<p>As it turns out, both of these cases are deficient. The problem with utilitarianism (at least in its current crude form) is that it ends up implying that slavery is not wrong, on the grounds that the intense suffering of the few may result in the highest levels of happiness for the many. This is unacceptable, so the argument above obtains. Analogously, the checkmate function will misidentify checked boards as being checkmated. The fact that the current player’s king can be captured just means that she must move her king out of check, not that its capture is inevitable.</p>

<p>The point, however, is that both computer programming and philosophy involve analytically determining the consequences of one’s statements; and both necessitate a certain creativity in subsequently modifying one’s statements accordingly.</p>

<h2 id="historical-development">Historical Development</h2>

<p>Besides these concrete similarities, academic philosophy played a fascinating role in the historical development of computing.</p>

<p>The conceptual work that made the advent of modern computing possible took place in the early seventeen hundreds, when the philosopher and mathematician G.W.Leibniz developed an algebraic logic. In this logic, ones and zeros represent true or false states. The reason this is significant is that Leibniz’s ones and zeros would later be rendered mechanically as on or off switches in the first primitive computers. Although it took several hundred more years and the work of countless other philosophers, mathematicians, and engineers to develop our modern notion of computing, its conceptual foundation can be traced back to Leibniz’s philosophical logic.</p>

<p>The influence of philosophy on computer science did not stop at Leibniz, however. In the early nineteen hundreds, the philosophers Bertrand Russell and Alfred North Whitehead wrote <em>Principia Mathematica</em>, a nearly 2,000 page book written largely in formal logic that aimed to couch all of mathematics in terms of logic. Although the primary aim of this book was later demonstrated to be impossible by Gödel, the <em>Principia</em> also set out a theory of types that was later put to use by computer scientists. According to Constable’s brief history, Russell and Whitehead’s theory of types</p>

<blockquote>
  <p>…provided a basis for both a precise semantics and elegant programming logics. It was in this context that computer scientists and logicians created the type theories that are deeply connected to <em>Principia Mathematica</em> and serve now as comprehensive logical accounts of computing, computational mathematics, and programming logics (<a href="https://www.srcf.ucam.org/principia/files/rc.pdf">Constable</a> 3).</p>
</blockquote>

<p>Today the influence of philosophy on computer science continues, especially in the ares of artificial intelligence, the representation of information, language, and other things.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/04/17/ski-free/">
        SkiFree
      </a>
    </h1>

    <span class="post-date">17 Apr 2016</span>

    <html>
  <head>
    <meta charset="utf-8">
    <title>SkiFree</title>
    <style>
      #canvas {
        display: block;
        border: 1px solid #ccc;
        border-radius: 6px;
        width: 500px;
        height: 500px;
        background-image: url('/assets/ski-free-background.png');
        background-size: contain;
      }
    </style>
  </head>
  <body>
    <div style="display:none;">
     <img id="obstacles"
      src="/assets/obstacles.png">
     <img id="skier"
      src="/assets/skier.png">
    </div>
    <p>Here's a clone of the classic game SkiFree that I made with Javascript Canvas as part of a/A's curriculum. Check out the repo on GitHub <a href="https://github.com/AlexanderRichey/SkiFree">here.</a> <strong>Click to begin</strong> and use the mouse to control your skier.</p>
    <canvas width="500" height="500" id="canvas"></canvas>
    <script type="text/javascript" src="/javascripts/skifree.min.js" charset="utf-8"></script>
  </body>
</html>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>

    </div>

  </body>
</html>

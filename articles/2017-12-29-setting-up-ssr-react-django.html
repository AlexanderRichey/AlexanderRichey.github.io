<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Alex Richey | Setting Up Server Side Rendering with React, Redux, and Django</title><meta name=description content="At Meural, we decided to implement server side rendering in order to increase our SEO exposure and to make social media sharing more effective..."><link rel=alternate type=application/rss+xml href=/rss.xml><script async src=https://plausible.io/js/analytics.js></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,400;0,700;1,400;1,700&family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400;1,700&display=swap" rel=stylesheet><link rel=stylesheet href=/styles/styles.838eea33.css><script defer src=https://cdn.jsdelivr.net/npm/@hotwired/turbo@7.1.0/dist/turbo.es2017-umd.js></script><script defer src=/scripts/img-grow.990f00ca.js></script><meta property="og:site_name" content="Alex Richey"><meta name=twitter:site content="@AlexanderRichey"><link rel=me href=https://twitter.com/AlexanderRichey><link rel=me href=https://github.com/AlexanderRichey><link rel=webmention href=https://webmention.io/alexrichey.com/webmention><link rel=pingback href=https://webmention.io/alexrichey.com/xmlrpc><meta property="og:title" content="Setting Up Server Side Rendering with React, Redux, and Django"><meta property="og:type" content="article"><meta property="og:description" content="At Meural, we decided to implement server side rendering in order to increase our SEO exposure and to make social media sharing more effective..."><meta name=twitter:title content="Setting Up Server Side Rendering with React, Redux, and Django"><meta name=twitter:description content="At Meural, we decided to implement server side rendering in order to increase our SEO exposure and to make social media sharing more effective..."></head><body><header class=top-header><div class=top-header-title><h1><a href=/>Alex Richey</a></h1><small>Software Engineer @ Amazon</small></div><nav class=top-header-nav><a class=top-header-nav-item href=/>Posts</a>
<a class=top-header-nav-item href=/about.html>About</a></nav></header><main class=container><article><div class=article-header><h1>Setting Up Server Side Rendering with React, Redux, and Django</h1><time class=article-date datetime="2017-12-29 00:00:00 +0000 UTC">29 December 2017</time></div><div><div class=message>My article on server side rendering originally published on Meural's <a href=https://medium.com/meural-product-development/setting-up-server-side-rendering-with-react-redux-and-django-4d6f4d2fd705>Product Blog</a>.</div><p>At Meural, we decided to implement server side rendering in order to increase our SEO exposure and to make social media sharing more effective. In this post, I’ll talk about how server side rendering works and the implementation that I developed.</p><h2>Background</h2><p>In traditional web applications, web pages are rendered on the client side. The browser receives a blob of JavaScript from the server, processes it, and paints the UI that the user sees. In server rendered applications, on the other hand, the first render of a web page is done on the server. The browser receives a pre-rendered page, which it can display without running any JavaScript. This enables better SEO exposure, since many web crawlers cannot run JavaScript, and faster perceived page load times.</p><p>There are also some downsides to server side rendering. These include slower server response time and, in lower bandwidth environments, slower time to interactive. For apps that run behind login screens, whose content is private, these downsides might make server side rendering less than worthwhile. For our use case, however, the benefits well outweigh the costs. Most of our app’s pages are public facing, so exposure to web crawlers is essential.</p><h2>Preliminary Considerations</h2><p>Implementing server side rendering is not a trivial task. In response to this fact, a number of libraries have emerged to make implementation a bit easier. These include Next.js, Razzle, numerous boilerplates, and others.</p><p>These libraries and frameworks can be a good choice for rapidly prototyping a feature or when starting a new app, but I would not recommend them for use in production or for extant apps. The reason for this is that using them requires surrendering a large portion of your codebase to them, which makes debugging and optimization more difficult, if not impossible, and makes you ignorant of how your app is really working. What’s more, integrating such a framework into an extant application is often more trouble than it’s worth.</p><p>Therefore, I developed a custom implementation of server side rendering at Meural. I hope that our stack is similar enough to that of other companies so that other developers might find this article useful. Our frontend uses React, React Router 3, and Redux, while our backend is a monolithic Django application.</p><h2>The High-Level View</h2><p>At a high level, setting up server side rendering consists in setting up the following chain of events.</p><p><img src=/images/ssr.jpg alt="SSR Schema"></p><p>Since our primary application server is a Django application, which cannot understand JavaScript, we need a JavaScript runtime to render our React frontend. For this, we’ll use a Node server. When a request hits our primary Django server, we’ll query our database to get the info we need. Next we’ll send that info in an HTTP <code>POST</code> request to our Node server, which will return our markup, plus the final state of our Redux store. Finally, we’ll embed this information into the HTML response of our Django app and send it to the client.</p><h2>Node-Django Interaction</h2><p>Let’s begin by setting up the Node server. I decided to use Express.js because it is battle-tested and very easy to use. Note that we are reading our <code>NODE_HOST</code> and <code>NODE_PORT</code> variables from our runtime environment.</p><pre class=chroma><span class=c1>// server.js
</span><span class=c1></span>
<span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s1>&#39;http&#39;</span>
<span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span>
<span class=kr>import</span> <span class=nx>bodyParser</span> <span class=nx>from</span><span class=s1>&#39;body-parser&#39;</span>
<span class=kr>import</span> <span class=nx>morgan</span> <span class=nx>from</span> <span class=s1>&#39;morgan&#39;</span>
<span class=kr>import</span> <span class=p>{</span> <span class=nx>buildInitalState</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;./utils&#39;</span>
<span class=kr>import</span> <span class=nx>render</span> <span class=nx>from</span> <span class=s1>&#39;./render.jsx&#39;</span>

<span class=kr>const</span> <span class=nx>ADDRESS</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_HOST</span>
<span class=kr>const</span> <span class=nx>PORT</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_PORT</span>

<span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>()</span>
<span class=kr>const</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>

<span class=c1>// I&#39;ve increased the limit of the max payload size in case a huge page
</span><span class=c1>// needs to be rendered
</span><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>bodyParser</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>limit</span><span class=o>:</span> <span class=s1>&#39;10mb&#39;</span> <span class=p>}))</span>

<span class=c1>// Morgan is the very silly name of some logging middleware.
</span><span class=c1>// It logs requests to the console so that you can tell that
</span><span class=c1>// the server is doing anything.
</span><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>morgan</span><span class=p>(</span><span class=s1>&#39;combined&#39;</span><span class=p>))</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=s1>&#39;Render server here!&#39;</span><span class=p>)</span>
<span class=p>})</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/render&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// We know we&#39;ll need a path and the data for our initial state,
</span><span class=c1></span>  <span class=c1>// so let&#39;s save this stuff first
</span><span class=c1></span>  <span class=kr>const</span> <span class=nx>url</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>url</span>
  <span class=c1>// This function massages data into the shape of our Redux store
</span><span class=c1></span>  <span class=kr>const</span> <span class=nx>initialState</span> <span class=o>=</span> <span class=nx>buildInitialState</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>)</span>  
  
  <span class=c1>// We haven&#39;t written this function yet, but we know what we want
</span><span class=c1></span>  <span class=c1>// its signiture to be
</span><span class=c1></span>  <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>render</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>initialState</span><span class=p>)</span>

  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
    <span class=nx>html</span><span class=o>:</span> <span class=nx>result</span><span class=p>.</span><span class=nx>html</span><span class=p>,</span>
    <span class=nx>finalState</span><span class=o>:</span> <span class=nx>result</span><span class=p>.</span><span class=nx>finalState</span>
  <span class=p>})</span>
<span class=p>})</span>

<span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>PORT</span><span class=p>,</span> <span class=nx>ADDRESS</span><span class=p>,</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Render server listening at http://&#39;</span> <span class=o>+</span> <span class=nx>ADDRESS</span> <span class=o>+</span> <span class=s1>&#39;:&#39;</span> <span class=o>+</span> <span class=nx>PORT</span><span class=p>)</span>
<span class=p>})</span>
</pre><p>I recommend writing a simple <code>render</code> and <code>buildInitialState</code> functions for testing purposes that simply return some valid output of any kind. I also recommend testing this server with cURL before moving on to anything else.</p><p>Now let’s wire up the Django app and test its interaction with the Node server.</p><pre class=chroma><span class=c1># views.py</span>
<span class=kn>import</span> <span class=nn>requests</span>
<span class=kn>from</span> <span class=nn>django.conf</span> <span class=kn>import</span> <span class=n>settings</span>
<span class=kn>from</span> <span class=nn>django.shortcuts</span> <span class=kn>import</span> <span class=n>render</span>
<span class=kn>from</span> <span class=nn>sandwich.models</span> <span class=kn>import</span> <span class=n>Sandwich</span>
<span class=kn>from</span> <span class=nn>sandwich.serializers</span> <span class=kn>import</span> <span class=n>SandwichSerializer</span>
<span class=kn>from</span> <span class=nn>user.serializers</span> <span class=kn>import</span> <span class=n>UserSerializer</span>


<span class=k>def</span> <span class=nf>sandwich</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=nb>id</span><span class=p>):</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>sandwich</span> <span class=o>=</span> <span class=n>Sandwich</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=nb>id</span><span class=p>)</span>
        <span class=n>serializer</span> <span class=o>=</span> <span class=n>SandwichSerializer</span><span class=p>(</span><span class=n>sandwich</span><span class=p>)</span>
        <span class=n>sandwich_data</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>data</span>
    <span class=k>except</span> <span class=n>Sandwich</span><span class=o>.</span><span class=n>DoesNotExist</span><span class=p>:</span>
        <span class=n>sandwich_data</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=c1># The magic happens in our _react_render helper function</span>
    <span class=k>return</span> <span class=n>_react_render</span><span class=p>({</span><span class=s1>&#39;sandwich&#39;</span><span class=p>:</span> <span class=n>sandwich_data</span><span class=p>},</span> <span class=n>request</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>_react_render</span><span class=p>(</span><span class=n>content</span><span class=p>,</span> <span class=n>request</span><span class=p>):</span>
    <span class=c1># Let&#39;s grab our user&#39;s info if she has any</span>
    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=o>.</span><span class=n>is_authenticated</span><span class=p>():</span>
        <span class=n>serializer</span> <span class=o>=</span> <span class=n>UserSerializer</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=p>)</span>
        <span class=n>user</span> <span class=o>=</span> <span class=n>serializer</span><span class=o>.</span><span class=n>data</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>user</span> <span class=o>=</span> <span class=p>{}</span>

    <span class=c1># Here&#39;s what we&#39;ve got so far</span>
    <span class=n>render_assets</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s1>&#39;url&#39;</span><span class=p>:</span> <span class=n>request</span><span class=o>.</span><span class=n>path_info</span><span class=p>,</span>
        <span class=s1>&#39;user&#39;</span><span class=p>:</span> <span class=n>user</span>
    <span class=p>}</span>
    <span class=c1># Now we add the sandwich. We use the Dict#update method so that the</span>
    <span class=c1># key could be anything, like pizza or cake or burger.</span>
    <span class=n>render_assets</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=c1># All right, let&#39;s send it! Note that we set the content type to json.</span>
        <span class=n>res</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>RENDER_SERVER_BASE_URL</span> <span class=o>+</span> <span class=s1>&#39;/render&#39;</span><span class=p>,</span>
                            <span class=n>json</span><span class=o>=</span><span class=n>render_assets</span><span class=p>,</span>
                            <span class=n>headers</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;content_type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/json&#39;</span><span class=p>})</span>
        <span class=n>rendered_payload</span> <span class=o>=</span> <span class=n>res</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=o>...</span>
    <span class=c1># Beautiful! Let&#39;s render this stuff into our base template</span>
    <span class=k>return</span> <span class=n>render</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=s1>&#39;base.html&#39;</span><span class=p>,</span> <span class=n>rendered_payload</span><span class=p>)</span>
</pre><p>Here’s how we insert the rendered HTML payload into our Django template. Note that we use <a href=https://webpack.js.org/guides/getting-started/>Webpack</a> and <a href=https://github.com/ezhome/django-webpack-loader>django-webpack-loader</a> to handle our client-side JavaScript.</p><p></p><pre class=chroma><span class=c>&lt;!-- base.html --&gt;</span>
{% load render_bundle from webpack_loader %}
{% load webpack_static from webpack_loader %}

<span class=cp>&lt;!DOCTYPE html&gt;</span>
<span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;x-ua-compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;ie=edge&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>The Finest Deli<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>

    {% render_bundle &#39;bodega&#39; &#39;css&#39; %}
    {% render_bundle &#39;bodega&#39; &#39;js&#39; attrs=&#39;async&#39; %}
  <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>

    <span class=c>&lt;!-- Root --&gt;</span>
    <span class=p>&lt;</span><span class=nt>main</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;root&#34;</span><span class=p>&gt;</span>{{ html|safe }}<span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>

    <span class=c>&lt;!-- Redux State --&gt;</span>
    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
      <span class=nb>window</span><span class=p>.</span><span class=nx>__REDUX_STATE__</span> <span class=o>=</span> <span class=p>{{</span> <span class=nx>finalState</span><span class=o>|</span><span class=nx>safe</span> <span class=p>}}</span>
    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>

  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</pre><p></p><p>We can now test the interaction between Node and Django. Let’s start the Node server and the Django server, open up a browser, and go to the url that corresponds to our sandwich view. To prevent our React frontend from taking over the page on load, we’ll disable JavaScript in DevTools. If you see a page with the output that you defined in your <code>render</code> and <code>buildInitialState</code> functions, then all is well.</p><h2>Defining the Render Function</h2><p>It will be instructive to first look at the code of the <code>render</code> function and then to explain how it works.</p><pre class=chroma><span class=c1>// render.jsx
</span><span class=c1></span>
<span class=kr>import</span> <span class=nx>React</span> <span class=nx>from</span> <span class=s1>&#39;react&#39;</span>
<span class=kr>import</span> <span class=p>{</span> <span class=nx>Provider</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;react-redux&#39;</span>
<span class=kr>import</span> <span class=p>{</span> <span class=nx>match</span><span class=p>,</span> <span class=nx>RouterContext</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;react-router&#39;</span>
<span class=kr>import</span> <span class=nx>ReactDOMServer</span> <span class=nx>from</span> <span class=s1>&#39;react-dom/server&#39;</span>
<span class=kr>import</span> <span class=nx>configureStore</span> <span class=nx>from</span> <span class=s1>&#39;../bodega/src/scripts/store/store&#39;</span>
<span class=kr>import</span> <span class=nx>getRoutes</span> <span class=nx>from</span> <span class=s1>&#39;../bodega/src/scripts/components/routes&#39;</span>

<span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>render</span> <span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>initialState</span><span class=p>)</span> <span class=p>{</span>
  <span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=nx>configureStore</span><span class=p>(</span><span class=nx>initialState</span><span class=p>)</span>

  <span class=kr>const</span> <span class=nx>routes</span> <span class=o>=</span> <span class=nx>getRoutes</span><span class=p>(</span><span class=nx>store</span><span class=p>)</span>

  <span class=kd>let</span> <span class=nx>html</span><span class=p>,</span> <span class=nx>redirect</span>
  <span class=nx>match</span><span class=p>({</span> <span class=nx>routes</span><span class=p>,</span> <span class=nx>location</span><span class=o>:</span> <span class=nx>url</span> <span class=p>},</span> <span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>redirectLocation</span><span class=p>,</span> <span class=nx>renderProps</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>redirectLocation</span><span class=p>)</span> <span class=p>{</span>
      <span class=nx>redirect</span> <span class=o>=</span> <span class=nx>redirectLocation</span><span class=p>.</span><span class=nx>pathname</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>renderProps</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// Here&#39;s where the actual rendering happens
</span><span class=c1></span>      <span class=nx>html</span> <span class=o>=</span> <span class=nx>ReactDOMServer</span><span class=p>.</span><span class=nx>renderToString</span><span class=p>(</span>
        <span class=p>&lt;</span><span class=nt>Provider</span> <span class=na>store</span><span class=o>=</span><span class=p>{</span><span class=nx>store</span><span class=p>}&gt;</span>
          <span class=p>&lt;</span><span class=nt>RouterContext</span> <span class=p>{</span><span class=na>...renderProps</span><span class=p>}</span> <span class=p>/&gt;</span>
        <span class=p>&lt;/</span><span class=nt>Provider</span><span class=p>&gt;</span>
      <span class=p>)</span>
    <span class=p>}</span>
  <span class=p>})</span>

  <span class=k>if</span> <span class=p>(</span><span class=nx>redirect</span><span class=p>)</span> <span class=k>return</span> <span class=nx>render</span><span class=p>(</span><span class=nx>redirect</span><span class=p>,</span> <span class=nx>initialState</span><span class=p>)</span> <span class=c1>// Fun recursion
</span><span class=c1></span>
  <span class=kr>const</span> <span class=nx>finalState</span> <span class=o>=</span> <span class=nx>store</span><span class=p>.</span><span class=nx>getState</span><span class=p>()</span>

  <span class=k>return</span> <span class=p>{</span>
    <span class=nx>html</span><span class=p>,</span>
    <span class=nx>finalState</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre><p>The first thing the <code>render</code> function does is configure the Redux store. I used the same <code>configureStore</code> function that I had already defined in following the usual Redux API pattern.</p><p>The second thing the <code>render</code> function does is get the frontend routes of my React app, by calling a function I wrote called <code>getRoutes</code>. This function takes the Redux store as an argument and returns all of the routes to my app. It prevents code duplication because I can call it in both server and browser environments (See the <em>Handling the Client Side</em> section below to see how it is used in a browser environment).</p><p>The name <code>getRoutes</code>, though accurate, is somewhat incomplete. The function does not just get routes. It also gets the React components of which my app is composed, since they are embedded in the definitions of the routes themselves. Therefore, the <code>getRoutes</code> function is what links my existing React app to the render function.</p><p>Next, in order for the <code>render</code> function to match the desired route, I use React Router’s <code>match</code> function. This function’s first argument is an object containing all of my app’s routes as its first key — which we have from the <code>getRoutes</code> function — and the desired route as the second key. The match function’s second argument is a callback that gets evoked after matching is complete. In a successful matching, this callback’s third argument is a <code>renderProps</code> object. These <code>renderProps</code> represent the state of my app’s props at a given route. I pass this object into React-Router’s <code>&lt;RouterContext></code> component (which is a static version of its more familiar <code>&lt;Router></code> component) to render the state of our app at the matched route.</p><p>To give the components of my app access to the Redux store, I wrap the <code>&lt;RouterContext></code> component with the <code>&lt;Provider></code> component from the React-Redux library.</p><p>Next, I call <code>ReactDOMServer#renderToString</code> with this wrapped component as its argument to render the state of my application at the matched route to HTML.</p><p>Finally, I call <code>getState</code> on my Redux store to extract its final state in case the rendering process changed anything.</p><p>If the match function fails to match the desired route, the second argument of its callback is a <code>redirectLocation</code> argument. In this case, I recursively call the <code>render</code> function with this new desired route. I am confident that there will never be a chain of infinite redirects because I have defined a wildcard route to handle such cases.</p><h2>Calling the Render Function</h2><p>The render function will not work as it is currently defined. The reason for this is that the JSX used in the function itself, as well as in the rest of my app, is not understood in Node runtimes. Therefore, I use Webpack and Babel to transpile my <code>render.jsx</code> file into Node compliant code. All I had to do to make this work was to copy my existing webpack config, change the entry point to <code>render.jsx</code>, and replace the target parameter with <code>target: ‘node’</code>.</p><p>When transpiling, I ran into some errors. Since this version of my React app will not be running in the browser, window and document will not be defined. Therefore, I had to move all references to <code>window</code> and <code>document</code> to functions that are executed only after the DOM is accessible. This involved moving references to <code>window</code> and <code>document</code> from methods like <code>Component#constructor</code> to methods like <code>Component#componentDidMount</code>. Unlike <code>Component#constructor</code>, <code>Component#componentDidMount</code> will only be called after the component has been mounted to the DOM. I also had to abandon some third-party libraries that relied on <code>window</code> or <code>document</code> in problematic places.</p><h2>Handling the Client Side</h2><p>Now that my server responds with a fully rendered page of my app, I need to adjust my client side JS to expect this. Here’s the code I wrote.</p><pre class=chroma><span class=c1>// entry.js
</span><span class=c1></span>
<span class=kr>import</span> <span class=nx>React</span> <span class=nx>from</span> <span class=s1>&#39;react&#39;</span>
<span class=kr>import</span> <span class=nx>ReactDOM</span> <span class=nx>from</span> <span class=s1>&#39;react-dom&#39;</span>
<span class=kr>import</span> <span class=p>{</span> <span class=nx>match</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;react-router&#39;</span>
<span class=kr>import</span> <span class=p>{</span> <span class=nx>Provider</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;react-redux&#39;</span>
<span class=kr>import</span> <span class=p>{</span> <span class=nx>Router</span><span class=p>,</span> <span class=nx>browserHistory</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;react-router&#39;</span>

<span class=kr>import</span> <span class=nx>configureStore</span> <span class=nx>from</span> <span class=s1>&#39;./bodega/store/store&#39;</span>
<span class=kr>import</span> <span class=nx>Root</span> <span class=nx>from</span> <span class=s1>&#39;./bodega/components/root&#39;</span>
<span class=kr>import</span> <span class=nx>getRoutes</span> <span class=nx>from</span> <span class=s1>&#39;./bodega/components/routes&#39;</span>

<span class=kr>import</span> <span class=s1>&#39;./styles/main.scss&#39;</span>

<span class=k>if</span> <span class=p>(</span><span class=nb>document</span><span class=p>.</span><span class=nx>readyState</span> <span class=o>===</span> <span class=s1>&#39;loading&#39;</span><span class=p>)</span> <span class=p>{</span>
  <span class=nb>document</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;DOMContentLoaded&#39;</span><span class=p>,</span> <span class=nx>initializeApp</span><span class=p>)</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
  <span class=nx>initializeApp</span><span class=p>()</span>
<span class=p>}</span>

<span class=kd>function</span> <span class=nx>initializeApp</span> <span class=p>()</span> <span class=p>{</span>
  <span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=nx>configureStore</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>__REDUX_STATE__</span><span class=p>)</span>

  <span class=kr>const</span> <span class=p>{</span> <span class=nx>pathname</span><span class=p>,</span> <span class=nx>search</span><span class=p>,</span> <span class=nx>hash</span> <span class=p>}</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>location</span>
  <span class=kr>const</span> <span class=nx>location</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>pathname</span><span class=si>}${</span><span class=nx>search</span><span class=si>}${</span><span class=nx>hash</span><span class=si>}</span><span class=sb>`</span>
  <span class=kr>const</span> <span class=nx>routes</span> <span class=o>=</span> <span class=nx>getRoutes</span><span class=p>(</span><span class=nx>store</span><span class=p>)</span>

  <span class=nx>match</span><span class=p>({</span> <span class=nx>routes</span><span class=p>,</span> <span class=nx>location</span> <span class=p>},</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>ReactDOM</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span>
      <span class=p>&lt;</span><span class=nt>Provider</span> <span class=na>store</span><span class=o>=</span><span class=p>{</span><span class=nx>store</span><span class=p>}&gt;</span>
        <span class=p>&lt;</span><span class=nt>Router</span> <span class=na>history</span><span class=o>=</span><span class=p>{</span><span class=nx>browserHistory</span><span class=p>}&gt;</span>
          <span class=p>{</span><span class=nx>routes</span><span class=p>}</span>
        <span class=p>&lt;/</span><span class=nt>Router</span><span class=p>&gt;</span>
      <span class=p>&lt;/</span><span class=nt>Provider</span><span class=p>&gt;,</span>
      <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;root&#39;</span><span class=p>)</span>
    <span class=p>)</span>
  <span class=p>})</span>
<span class=p>}</span>
</pre><p>You might have noticed that I added an <code>async</code> attribute to my script tag in <code>base.html</code>. The <code>async</code> attribute makes the tag non-render-blocking, which means that the browser won’t wait for the entire script to download before rendering. This produces a considerable speed increase, especially with large JavaScript bundles. However, it also means that it is possible for the script to be executed at any time during the load process, which means that the standard procedure of waiting for <code>DOMContentLoaded</code> before rendering with ReactDOM might not always work, since <code>DOMContentLoaded</code> might have already fired, in which case, the React app would never get executed and the page would never become interactive. Therefore, I check the <code>document.readyState</code> when the bundle is initially executed. If the <code>readyState</code> is <code>complete</code> or <code>interactive</code>, I initialize my React app right away. Otherwise, I add listener for <code>DOMContentLoaded</code> and use my initialize function as the callback.</p><p>In my <code>initializeApp</code> function, I get the current state of the Redux store from the window and pass it into <code>configureStore</code> to setup Redux. Next, I match the current route, just as I did on the server side, using the same <code>getRoutes</code> and <code>match</code> functions which I discussed above. Instead of calling <code>ReactDOM#render</code>, which is the usual pattern in client rendered apps, I call <code>ReactDOM#hydrate</code>, which sets up React’s virtual DOM and installs listeners to make the page interactive.</p><h2>Conclusion</h2><p>Since deploying this project, we have seen much better SEO at Meural. Now a Google search for the terms <code>meural</code> and some artist’s name will yield a result of that artist’s page or one of her playlists, if that artist is in our collection. Prior to this deployment, this was not possible, since we had exposed only one webpage, which contained our single-page React app.</p></div><aside class=aside-post-container><div class="aside-post left"><a href=/articles/2018-07-10-bringing-our-frontend-to-the-bleeding-edge.html><p class=aside-post-arrow>&#8592; Newer</p><p class=aside-post-title>Bringing Meural's Frontend to the Bleeding Edge</p></a></div><div class="aside-post right"><a href=/articles/2016-05-21-from-philosophy-to-cs.html><p class=aside-post-arrow>Older &#8594;</p><p class=aside-post-title>From Philosophy to Computer Science</p></a></div></aside></article></main><footer><section class=subscribe><form action=https://buttondown.email/api/emails/embed-subscribe/AlexanderRichey method=post target=popupwindow onsubmit="window.open('https://buttondown.email/AlexanderRichey','popupwindow')" class=embeddable-buttondown-form><h3>Subscribe to my newsletter</h3><p class=subscribe-desc>Subscribe to get my <span class=nowrap>latest articles by email.</span></p><input type=email name=email id=bd-email placeholder=jeff@amazon.com>
<input type=submit class=subscribe-submit value=Subscribe><p><span class=subscribe-buttondown><a href=https://buttondown.email target=_blank>Powered by Buttondown.</a></span></p></form></section><section class=footer-mouse><span>© 2023. All rights reserved. <span class=nowrap><a rel=alternate type=application/rss+xml href=/rss.xml>RSS</a>. <a href=/>Posts.</a> <a href=/about.html>About.</a></span></span></section><section class=footer-social><a href=https://twitter.com/AlexanderRichey target=_blank><svg class="footer-icon twitter" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000" height="800" width="800" id="Layer_1" viewBox="0 0 310 310"><title>Follow me on Twitter</title><g id="XMLID_826_"><path id="XMLID_827_" d="M302.973 57.388c-4.87 2.16-9.877 3.983-14.993 5.463 6.057-6.85 10.675-14.91 13.494-23.73.632-1.977-.023-4.141-1.648-5.434-1.623-1.294-3.878-1.449-5.665-.39-10.865 6.444-22.587 11.075-34.878 13.783-12.381-12.098-29.197-18.983-46.581-18.983-36.695.0-66.549 29.853-66.549 66.547.0 2.89.183 5.764.545 8.598C101.163 99.244 58.83 76.863 29.76 41.204c-1.036-1.271-2.632-1.956-4.266-1.825-1.635.128-3.104 1.05-3.93 2.467-5.896 10.117-9.013 21.688-9.013 33.461.0 16.035 5.725 31.249 15.838 43.137-3.075-1.065-6.059-2.396-8.907-3.977-1.529-.851-3.395-.838-4.914.033-1.52.871-2.473 2.473-2.513 4.224-.007.295-.007.59-.007.889.0 23.935 12.882 45.484 32.577 57.229-1.692-.169-3.383-.414-5.063-.735-1.732-.331-3.513.276-4.681 1.597-1.17 1.32-1.557 3.16-1.018 4.84 7.29 22.76 26.059 39.501 48.749 44.605-18.819 11.787-40.34 17.961-62.932 17.961-4.714.0-9.455-.277-14.095-.826-2.305-.274-4.509 1.087-5.294 3.279-.785 2.193.047 4.638 2.008 5.895 29.023 18.609 62.582 28.445 97.047 28.445 67.754.0 110.139-31.95 133.764-58.753 29.46-33.421 46.356-77.658 46.356-121.367.0-1.826-.028-3.67-.084-5.508 11.623-8.757 21.63-19.355 29.773-31.536 1.237-1.85 1.103-4.295-.33-5.998C307.394 57.037 305.009 56.486 302.973 57.388z"/></g></svg></a><a href=https://quil.la/IHQNK target=_blank><svg class="footer-icon email" width="800" height="800" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><title>Send me an email</title><path d="M16 12c0 2.2091-1.7909 4-4 4-2.20914.0-4-1.7909-4-4 0-2.20914 1.79086-4 4-4 2.2091.0 4 1.79086 4 4zm0 0v1.5c0 1.3807 1.1193 2.5 2.5 2.5v0c1.3807.0 2.5-1.1193 2.5-2.5V12c0-4.97056-4.0294-9-9-9-4.97056.0-9 4.02944-9 9 0 4.9706 4.02944 9 9 9h4" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a></section></footer></body></html>